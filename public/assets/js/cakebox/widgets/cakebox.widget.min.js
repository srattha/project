var cakeboxWidget=function(){this.defaults={id:"",chartType:"",chart:{color:"",label:{color:""},compare:{color:"",label:{color:""}}},chartTitle:"",fixedHeight:!0,xAxis:{name:"",data:[]},yAxis:{format:"{value}",line:{color:""}},grid:{x:100,x2:20,y:85,y2:25},btn_reload:{id:"",title:"Reload data"},btn_remove:{id:"",title:"Remove this chart",confirm:"Please confirm to remove this chart"},filters:{enabled:!0,branch:{id:"",value:""},compare:{id:"",value:""},date:{id:"",value:""}},loading:"Loading"},this.obj=null,this.demo=!1,this.chart_o=null,this.default_chart_type="bar",this.supported_chart_types={bar:"Bar Chart",line:"Line Chart"},this.branches={branch1:"BRANCH 1",branch2:"BRANCH 2"},this.date_filters={today:"TODAY",yesterday:"YESTERDAY",week:"LAST 1 WEEK",month:"LAST 1 MONTH"},this.data_api_url="",this.branch_api_url="",this.date_filter_url="",this.chart_options={}};cakeboxWidget.prototype.init=function(){this.validChartType(),this.createUI(),this.adjustWidget(),this.initChart(),$(".widget_dd[rel=widget_"+this.settings.id+"]").addClass("disabled")},cakeboxWidget.prototype.createUI=function(){var t=this,e=$("<div />").attr("id","widget_"+this.settings.id).addClass("cakebox-widget").appendTo(this.obj),i=$("<h3 />").addClass("handle").appendTo(e);""!==this.settings.chartTitle&&i.text(this.settings.chartTitle);var s=$("<div />").addClass("panel").addClass("panel-flat").appendTo(e),a=$("<div />").addClass("heading-elements").appendTo(i),n=$("<ul />").addClass("icons-list").appendTo(a);if(Object.keys(this.supported_chart_types).length>1){var r=$("<li />").appendTo(n),o=$("<select />").attr("id",this.settings.id+"_charttype").appendTo(r);$.each(this.supported_chart_types,function(e,i){var s=$("<option />").attr("value",e).text(i).appendTo(o);e===t.settings.chartType&&s.attr("selected","selected")}),o.change(function(){t.settings.chartType=$(this).val(),t.validChartType(),t.setChartOption()})}if(null!==this.settings.btn_reload&&($("<li />").html('<a id="'+this.settings.btn_reload.id+'" data-action="reload" title="'+this.settings.btn_reload.title+'"></a>').appendTo(n),$("#"+t.settings.btn_reload.id).click(function(e){e.preventDefault(),t.demo===!1&&t.loadData()})),null!==this.settings.btn_remove&&($("<li />").html('<a id="'+this.settings.btn_remove.id+'" data-action="close" title="'+this.settings.btn_remove.title+'" rel="'+this.settings.id+'"></a>').appendTo(n),$("#"+t.settings.btn_remove.id).click(function(e){e.preventDefault(),null!==t.settings.btn_remove.confirm&&""!==t.settings.btn_remove.confirm?confirm(t.settings.btn_remove.confirm)&&t.removeMe():t.removeMe()})),null!==this.settings.filters&&this.settings.filters.enabled===!0){var d=$("<div />").addClass("panel-heading").appendTo(s),l=$("<div />").addClass("row").appendTo(d),h=$("<div />").addClass("col-md-12").appendTo(l),c=$("<div />").addClass("row").addClass("btn_top").appendTo(h),p=$("<div />").addClass("col-md-4").appendTo(c);if("undefined"!=typeof this.settings.filters.branch&&null!==this.settings.filters.branch){var f=$("<select />").attr("id",this.settings.filters.branch.id).addClass("form-control").appendTo(p);$("<option />").attr("value","").text("-CHOOSE AREA-").appendTo(f),f.change(function(){var e=$(this).val();$("#"+t.settings.filters.compare.id+" option").css("display","inherit"),""!==e&&$("#"+t.settings.filters.compare.id+" #vcp_"+e).css("display","none");var i=$("#"+t.settings.filters.compare.id).val();e===i&&$("#"+t.settings.filters.compare.id).val(""),t.demo===!1&&t.loadData()})}var g=$("<div />").addClass("col-md-4").appendTo(c);if("undefined"!=typeof this.settings.filters.compare&&null!==this.settings.filters.compare){var u=$("<select />").attr("id",this.settings.filters.compare.id).addClass("form-control").appendTo(g);$("<option />").attr("value","").text("COMPARE").appendTo(u),$("<option />").attr("value","average").text("AVERAGE").appendTo(u),u.change(function(){t.demo===!1&&t.loadData()})}if("undefined"!=typeof this.settings.filters.date&&null!==this.settings.filters.date){var v=$("<div />").addClass("col-md-4").appendTo(c);$("<select />").attr("id",this.settings.filters.date.id).addClass("form-control").appendTo(v)}this.loadBranches(),this.loadFilters()}var m=$("<div />").addClass("panel-body").appendTo(s),b=$("<div />").addClass("row").appendTo(m),y=$("<div />").appendTo(b),_=$("<div />").addClass("chart-container").appendTo(y);$("<div />").addClass("chart-loading").attr("id",this.settings.id+"_loading").html('<div><i class="icon-spinner2 spinner"></i> '+this.settings.loading+"</div>").appendTo(_);var C=$("<div />").addClass("chart").attr("id",this.settings.id).appendTo(_);this.settings.fixedHeight===!0&&C.addClass("has-fixed-height")},cakeboxWidget.prototype.validChartType=function(){var t=this.settings.chartType;"undefined"==typeof this.supported_chart_types[t]&&(this.settings.chartType=this.default_chart_type)},cakeboxWidget.prototype.initChart=function(){var t=this;require.config({paths:{echarts:"assets/js/plugins/visualization/echarts"}}),require(["echarts","echarts/theme/limitless","echarts/chart/bar","echarts/chart/line","echarts/chart/pie"],function(e,i){t.createChart(e,i)})},cakeboxWidget.prototype.createChart=function(t,e){var i=this;i.chart_o=t.init(document.getElementById(i.settings.id),e),i.setChartOption(!0),window.addEventListener("resize",function(){setTimeout(function(){i.chart_o.resize()},200)},!0)},cakeboxWidget.prototype.setChartOption=function(t){var e=this;"undefined"==typeof t&&(t=!1),this.chart_options=e.demo?cakeboxChart.getDemoOption(this.settings.chartType):cakeboxChart.getChartOptions(this.settings.chartType,this.settings.grid,this.settings.yAxis,this.settings.xAxis),e.demo?this.updateChartData():t===!0?this.loadData(!0):this.updateChartData()},cakeboxWidget.prototype.getQueryParameter=function(t){"undefined"==typeof t&&(t=!1);var e={};if(null!==this.settings.filters&&this.settings.filters.enabled===!0){if("undefined"!=typeof this.settings.filters.branch&&null!==this.settings.filters.branch){var i=t===!0?this.settings.filters.branch.value:$("#"+this.settings.filters.branch.id).val();e.area=i}if("undefined"!=typeof this.settings.filters.compare&&null!==this.settings.filters.compare){var s=t===!0?this.settings.filters.compare.value:$("#"+this.settings.filters.compare.id).val();e.compare=s}if("undefined"!=typeof this.settings.filters.date&&null!==this.settings.filters.date){var a=t===!0?this.settings.filters.date.value:$("#"+this.settings.filters.date.id).val();e.date=a}}return e},cakeboxWidget.prototype.loadData=function(t){console.log("widget load data")},cakeboxWidget.prototype.updateChartData=function(){this.chart_o.clear(),this.setDataSeriesFormat(),this.displayData()},cakeboxWidget.prototype.setDataSeriesFormat=function(){},cakeboxWidget.prototype.displayData=function(){this.chart_o.setOption(this.chart_options),$("#"+this.settings.id+"_loading").hide("fast")},cakeboxWidget.prototype.loadBranches=function(){var t=this;if("undefined"!=typeof this.settings.filters.branch&&null!==this.settings.filters.branch){var e=$("#"+this.settings.filters.branch.id);e.find("option").not(":first").remove()}if("undefined"!=typeof this.settings.filters.compare&&null!==this.settings.filters.compare){var i=$("#"+this.settings.filters.compare.id);i.find("option").slice(2).remove()}t.branches=[],t.demo?t.populateBranch():$.get(t.branch_api_url,function(e){1===e.result?t.branches=e.data:console.log("Branch loading error: "+e.msg),t.populateBranch()},"json")},cakeboxWidget.prototype.populateBranch=function(){var t=this,e=null,i=null;"undefined"!=typeof t.settings.filters.branch&&null!==t.settings.filters.branch&&(e=$("#"+t.settings.filters.branch.id)),"undefined"!=typeof t.settings.filters.compare&&null!==t.settings.filters.compare&&(i=$("#"+t.settings.filters.compare.id)),$.each(t.branches,function(s,a){if(null!==e){var n=$("<option />").attr("value",a.id).text(a.level_name).appendTo(e);a.id===t.settings.filters.branch.value&&n.attr("selected","selected")}if(null!==i){var r=$("<option />").attr("value",a.id).attr("id","vcp_"+a.id).addClass("cp_"+a.id).text(a.level_name).appendTo(i);a.id===t.settings.filters.compare.value&&r.attr("selected","selected")}}),null!==e&&null!==i&&""!==t.settings.filters.branch.value&&(t.settings.filters.branch.value===t.settings.filters.compare.value?i.val(""):i.find("#vcp_"+t.settings.filters.branch.value).css("display","none"))},cakeboxWidget.prototype.loadFilters=function(){var t=this,e=$("#"+t.settings.filters.date.id);e.find("option").remove(),t.demo?t.populateFilter():(this.date_filters={},$.get(t.date_filter_url,function(e){1===e.result?t.date_filters=e.data:(console.log("Filters loading error: "+e.msg),console.log(e)),t.populateFilter()},"json"))},cakeboxWidget.prototype.populateFilter=function(){var t=this,e=$("#"+t.settings.filters.date.id);$.each(t.date_filters,function(i,s){var a=$("<option />").attr("value",i).text(s).appendTo(e);i===t.settings.filters.date.value&&a.attr("selected","selected")}),e.change(function(){t.demo===!1&&t.loadData()})},cakeboxWidget.prototype.adjustWidget=function(){this.obj.width()<500?this.obj.addClass("box_sm"):this.obj.removeClass("box_sm")},cakeboxWidget.prototype.removeMe=function(){this.obj.remove(),$(".widget_dd[rel=widget_"+this.settings.id+"]").removeClass("disabled")},cakeboxWidget.prototype.clone=function(t){if(null==t||"object"!=typeof t)return t;var e=t.constructor();for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e},cakeboxWidget.prototype.refreshChart=function(){this.chart_o.resize(),this.adjustWidget()},cakeboxWidget.prototype.removeChart=function(){this.removeMe()};